<!-- 
Microsoft Speech SDK
====================


FEATURES
--------
* Short-form recognition.
* Long-form dictation.
* Recognition with intent.
* Integrated microphone support.
* External audio support.

LICENSE
-------
© 2015 Microsoft. All rights reserved.  
This document is provided “as-is”. Information and views expressed in this document, including URL and other Internet Web site references, may change without notice.  
Some examples depicted herein are provided for illustration only and are fictitious.  No real association or connection is intended or should be inferred. 
This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes. This 
document is confidential and proprietary to Microsoft. It is disclosed and can be used only pursuant to a non-disclosure agreement. 
-->

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta http-equiv="Set-Cookie" content="～" expires=Fri, 31-Dec-1999 23:59:59 GMT>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.csvToTable.js"></script>
    <!--<script src="speech.1.0.0.js" type="text/javascript"></script>-->
    <script type="text/javascript">
        function init() {
            try{
                ws = new WebSocket('ws://' + 'aipocweb.azurewebsites.net' + '/apis/wsserver');

                function open() {
                    if (ws == null) {
                        // WebSocket の初期化
                        ws = new WebSocket(websocketUri);
                        document.getElementById("output").value = "呼ばれた";
                    }
                }

                // 接続イベント
                ws.onopen = function onOpen(evt) {
                    //ここで待受け画面に切り替える
                    document.getElementById("output").value = "接続/待機状態";
                }

                 // メッセージ受信イベント
                ws.onmessage = function onMessage(evt) {
                    if (evt && evt.data) {
                        var jsonData = JSON.parse(evt.data);

                        // 状態により画面表示を切り替える
                        switch (jsonData["destStatus"]) {
                            case "waitFace":
                                document.getElementById("output").value ="待機状態";
                                break;
                            case "waitQuestion":
                                document.getElementById("output").value ="質問待機";
                                break;
                            case "showAnswer":
                                //document.getElementById("label1") = "回答表示";
                                document.getElementById("output").value = jsonData["text"];
                                break;
                            case "endApplication":
                                document.getElementById("output").value = "終了";
                                break;
                        }
                    }
                 }

                 // エラーイベント
                 ws.onerror = onError =  function onError(event) {
                     //chat("エラーが発生しました。");
                     alert("エラーが発生しました");
                     //ここで待ち受け画面にss切り替える
                 }

                 // 切断イベント
                 ws.onclose = function onClose(event) {
                     //chat("切断しました。3秒後に再接続します。(" + event.code + ")");
                     ws = null;
                     setTimeout("open()", 3000);
                 }
            } catch (e) { alert(e.message); }
        };

        function setAnswer(text) {
            //document.getElementById("output").value += text;
        }

        function setCommodityTable(text) {
            metatag = text.split("#");
            metatag_t = metatag[1].trim();
            switch (metatag_t) {
                case "バナナ":
                    $('#dt-commodity').CSVToTable('data/banana.csv');
                    break;
                case "生姜":
                    $('#dt-commodity').CSVToTable('data/ginger.csv');
                    break;
                case "にんじん":
                    $('#dt-commodity').CSVToTable('data/carrot.csv');
                    break;
                case "グレープフルーツ":
                    $('#dt-commodity').CSVToTable('data/grapefruit.csv');
                    break;
                case "アーモンド":
                    $('#dt-commodity').CSVToTable('data/almond.csv');
                    break;
                case "金柑":
                    $('#dt-commodity').CSVToTable('data/kumquat.csv');
                    break;
            }
            document.getElementById("label1").innerHTML = "おすすめの商品"
        }

        function start() {
            return;
        }

        function GetQnA() {
            var data = {question:getText()}
            $.ajax({
                type:"post",
                url:"https://westus.api.cognitive.microsoft.com/qnamaker/v1.0/knowledgebases/0bd0fcfa-5bdb-45d8-abb8-25d53cf6f9a0/generateAnswer",        // POST送信先のURL
                data:JSON.stringify(data),
                contentType: 'application/json',
                headers: { 'Ocp-Apim-Subscription-Key': 'f57ae0d4213342fb8f24db4af17942d3' },
                success: function (json_data) {   // 200 OK時
                    setAnswer(json_data["answer"]);
                    setCommodityTable(json_data["answer"]);
                },
                error: function() {         // HTTPエラー時
                    setAnswer("Server Error. Pleasy try again later.");
                },
                complete: function() {      // 成功・失敗に関わらず通信が終了した際の処理
                    //button.attr("disabled", false);  // ボタンを再び enableにする
                }
            });         
        }
    </script>
</head>
<body style="background-color:white">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <h2>
                    音声認識から回答までのテスト
                </h2>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12"><p>Microsoft Cognitive Servicesを利用したPoC</p></div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="useMic" checked/> マイクを使って話しかける
                    </label>
                </div>
            </div>
        </div>
        <div class="row"></div>
        <div class="row">
            <div class="col-sm-9"><button type="button" class="btn btn-primary" onclick="init()">話しかける</button></div>
            <div class="col-sm-1"></div>
            <div class="col-sm-2"></div>
        </div>
        <p></p>
        <form>
            <div class="form-group">
                <label>聞き取った内容</label>
                <textarea id="output" style='width:400px;' rows="5" class="form-control"></textarea>
            </div>
        </form>
        <div class="row">
            <div class="col-sm-9"><button type="button" class="btn btn-success" onclick="GetQnA()">回答表示</button></div>
            <div class="col-sm-1"></div>
            <div class="col-sm-2"></div>
        </div>
        <p></p>
        <form>
            <div class="form-group">
                <label>おすすめの回答</label>
                <textarea id="output_answer" style='width:400px;' rows="5" class="form-control"></textarea>
            </div>
        </form>
        <p></p>
        <label id="label1"></label>
        <table id="dt-commodity"class="table table-striped"></table>
 
    </div>
</body>
</html>        
